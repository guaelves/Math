<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁöÆÂÖãÊïè‰πòÊ≥ïÂÜíÈö™</title>
    
<link rel="apple-touch-icon" href="pikminicon.png">
<link rel="icon" type="image/png" href="pikminicon.png">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <style>
        :root {
            --red: #ff5252; --yellow: #ffd740; --blue: #448aff;
            --purple: #9c27b0; --white: #ffffff; --rock: #607d8b;
            --wing: #f48fb1; --ice: #b3e5fc; --ghost: #ccff00;
            --bulborb-red: #d32f2f; --bulborb-skin: #f5deb3;
            --bread-light: #e3c08d; --bread-dark: #8b4513;
            --frog-yellow: #fff176; --snagret-blue: #4fc3f7;
            --snagret-beak: #ffd54f; --blowhog-white: #eeeeee;
            --wraith-glow: rgba(200, 255, 255, 0.7);
        }
        body { 
            font-family: "Arial", "Microsoft JhengHei", sans-serif; 
            background-color: #f1f8e9; display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden;
        }

        #game-box { 
            background: white; padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 0 #aed581; text-align: center; 
            width: 98vw; height: 95vh; display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
        }

        .stage { 
            flex: 1.5; background: #fffde7; border-radius: 20px; border: 4px solid #fff176; 
            margin-bottom: 10px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; position: relative;
        }
        #monster-host { transform: scale(0.65); height: 120px; display: flex; align-items: center; justify-content: center; transition: 0.4s; }

        /* --- È≠îËèáÊ®£Âºè --- */
        .mush-group { position: relative; width: 200px; height: 140px; display: flex; justify-content: center; align-items: flex-end; transform: scale(0.8); }
        .mushroom { display: flex; flex-direction: column; align-items: center; position: absolute; transform-origin: bottom center; }
        .m-cap { border-radius: 50% 50% 45% 45% / 85% 85% 35% 35%; z-index: 3; position: relative; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.2); }
        .m-gills { width: 80%; height: 10px; background: #e7d8c5; border-radius: 50%; margin-top: -8px; z-index: 2; background-image: repeating-conic-gradient(from 0deg, transparent 0 6deg, rgba(0,0,0,0.08) 6deg 12deg); }
        .m-stem { background: linear-gradient(to right, #d7ccc8, #efebe9, #d7ccc8); z-index: 1; margin-top: -10px; border-radius: 40% 40% 45% 45% / 20% 20% 30% 30%; border: 1px solid rgba(0,0,0,0.1); }
        .m-spots::before { content: ''; position: absolute; background: rgba(255,255,255,0.3); border-radius: 50%; width: 20px; height: 15px; top: 10px; left: 25px; box-shadow: 60px 10px 0 rgba(255,255,255,0.2), -15px 15px 0 rgba(255,255,255,0.1); }
        .m-giant .m-cap { width: 140px; height: 50px; background: radial-gradient(circle at 35% 25%, var(--m-color) 20%, #222 100%); }
        .m-giant .m-stem { width: 60px; height: 60px; }
        .m-small .m-cap { width: 50px; height: 22px; background: radial-gradient(circle at 35% 25%, var(--m-color) 20%, #222 100%); }
        .m-small .m-stem { width: 28px; height: 28px; }

        .effect-growth .m-giant { animation: mush-mega-grow 2.5s infinite alternate ease-in-out; }
        @keyframes mush-mega-grow { 0% { transform: scale(0.8); } 100% { transform: scale(2.0); } }

        .effect-glow .m-cap { animation: mush-rainbow-glow 2s infinite linear; }
        @keyframes mush-rainbow-glow { 
            0% { filter: hue-rotate(0deg) brightness(1.2) drop-shadow(0 0 10px white); }
            50% { filter: hue-rotate(180deg) brightness(1.6) drop-shadow(0 0 25px var(--m-color)); }
            100% { filter: hue-rotate(360deg) brightness(1.2) drop-shadow(0 0 10px white); }
        }

        .effect-fire .m-giant { animation: fire-shimmer 0.1s infinite alternate; }
        .effect-fire .m-giant .m-cap, .effect-fire .m-giant .m-stem { box-shadow: 0 0 20px #ff3d00, 0 0 40px #ff9100; border-color: #ff3d00; filter: saturate(2) brightness(1.2); }
        @keyframes fire-shimmer { 0% { transform: skewX(-1deg) scale(1.01); } 100% { transform: skewX(1deg) scale(0.99); } }
        .m-fire-flare { position: absolute; width: 10px; height: 10px; background: #ffab40; border-radius: 50% 0 50% 50%; opacity: 0; bottom: 40px; box-shadow: 0 0 15px #ff3d00; filter: blur(1px); animation: fire-rise 0.8s infinite ease-in; }
        @keyframes fire-rise { 0% { transform: translateY(0) scale(1) rotate(45deg); opacity: 1; } 100% { transform: translateY(-150px) scale(0) rotate(225deg); opacity: 0; } }

        /* ÊÄ™Áâ©Ê®£Âºè */
        .bulborb { position: relative; width: 180px; height: 120px; background: linear-gradient(to right, var(--bulborb-skin) 40%, var(--bulborb-red) 40%); border-radius: 70px 90px 90px 70px; animation: breathe 2s infinite ease-in-out; }
        .bulborb .eye { position: absolute; width: 35px; height: 45px; background: white; border: 2px solid #333; border-radius: 50%; top: -30px; }
        .bulborb .eye.left { left: 25px; transform: rotate(-10deg); }
        .bulborb .eye.right { left: 70px; transform: rotate(10deg); }
        .bulborb .eye::after { content: ''; position: absolute; width: 10px; height: 10px; background: black; border-radius: 50%; top: 15px; left: 12px; }
        .bulborb .spots { position: absolute; right: 20px; top: 30px; width: 18px; height: 18px; background: white; border-radius: 50%; box-shadow: 30px 20px 0 -2px white, 10px 45px 0 -4px white; }
        .breadbug { position: relative; width: 160px; height: 95px; background: repeating-linear-gradient(to right, var(--bread-light) 0, var(--bread-light) 25px, #d4a373 25px, #d4a373 30px); border-radius: 30px 40px 40px 30px; border: 3px solid var(--bread-dark); animation: crawl 1.2s infinite ease-in-out; }
        .breadbug::before { content: ''; position: absolute; left: -5px; top: -3px; width: 42px; height: 95px; background: var(--bread-light); border: 3px solid var(--bread-dark); border-radius: 30px 0 0 30px; }
        .bread-face { position: absolute; left: 5px; top: 32px; z-index: 5; width: 35px; text-align: center; }
        .bread-snout { width: 14px; height: 8px; background: #ffc0cb; border-radius: 50%; margin: 4px auto; }
        .wollywog { position: relative; width: 140px; height: 110px; background: var(--frog-yellow); border-radius: 50% 50% 40% 40%; animation: hop 1.5s infinite ease-in-out; }
        .wollywog .eye { position: absolute; width: 45px; height: 45px; background: white; border: 3px solid #333; border-radius: 50%; top: -25px; }
        .wollywog .eye.left { left: 10px; } .wollywog .eye.right { right: 10px; }
        .wollywog .eye::after { content: ''; position: absolute; width: 20px; height: 20px; background: black; border-radius: 50%; top: 12px; left: 12px; }
        .snagret-box { position: relative; width: 120px; height: 180px; }
        .snagret-hole { width: 120px; height: 30px; background: #3e2723; border-radius: 50%; position: absolute; bottom: 0; }
        .snagret-neck { position: absolute; width: 40px; height: 160px; background: repeating-linear-gradient(45deg, var(--snagret-blue) 0, var(--snagret-blue) 10px, #29b6f6 10px, #29b6f6 20px); bottom: 15px; left: 40px; border-radius: 20px 20px 0 0; animation: emerge 4s infinite ease-in-out; }
        .snagret-head { position: absolute; top: -20px; left: -10px; width: 60px; height: 50px; background: var(--snagret-blue); border-radius: 30px 30px 0 0; }
        .snagret-beak { position: absolute; right: -30px; top: 15px; width: 0; height: 0; border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 40px solid var(--snagret-beak); }
        .wraith-body { position: relative; width: 140px; height: 90px; background: var(--wraith-glow); border-radius: 50% 50% 40% 40%; box-shadow: 0 0 30px #fff; animation: move-wraith 3s infinite linear; }
        .wraith-roller { position: absolute; width: 180px; height: 50px; background: linear-gradient(#757575, #bdbdbd, #757575); border-radius: 10px; bottom: -30px; left: -20px; }
        .blowhog { position: relative; width: 160px; height: 120px; background: var(--blowhog-white); border-radius: 50% 60% 60% 50%; border: 1px solid #ddd; animation: float 3s infinite ease-in-out; }
        .blowhog-stripes { position: absolute; width: 100%; height: 100%; border-radius: inherit; background: repeating-linear-gradient(to right, transparent 0, transparent 30px, #ff8a80 30px, #ff8a80 35px); opacity: 0.4; }
        .blowhog-snout { position: absolute; left: -20px; top: 40px; width: 40px; height: 30px; background: #ff8a80; border-radius: 20px 0 0 20px; }
        .leg { position: absolute; width: 10px; height: 20px; background: rgba(0,0,0,0.1); bottom: -15px; border-radius: 5px; }
        
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes crawl { 0%, 100% { transform: translateX(-5px); } 50% { transform: translateX(5px); } }
        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-40px); } }
        @keyframes emerge { 0%, 100% { transform: translateY(140px); } 50% { transform: translateY(0); } }
        @keyframes move-wraith { 0%, 100% { transform: translateX(-30px); } 50% { transform: translateX(30px); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }

        #collection-container { margin-top: 10px; padding: 5px; background: #e8f5e9; border-radius: 20px; display: flex; flex-direction: column; border: 2px dashed #aed581; overflow-y: auto; }
        .collection-hint { font-size: 14px; color: #2e7d32; font-weight: bold; padding: 8px 0 4px 0; }
        .collection-row { display: flex; justify-content: space-around; align-items: center; gap: 2px; flex-wrap: nowrap; padding: 5px 0; border-bottom: 1px solid #c8e6c9; }
        .book-item { flex: 1; max-width: 45px; aspect-ratio: 1/1.2; position: relative; opacity: 0.15; filter: grayscale(1); transition: 0.5s; transform: scale(0.8); }
        .book-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(0.9); }
        .count-badge { position: absolute; top: -5px; right: -5px; background: #ff5252; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: bold; z-index: 10; border: 1.5px solid white; }
        .header { display: flex; justify-content: space-between; align-items: center; height: 35px; margin-bottom: 5px;}
        select { padding: 5px; border-radius: 10px; border: 2px solid #8bc34a; font-size: 14px; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 5px; margin-bottom: 5px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }
        .math { font-size: clamp(40px, 10vh, 80px); font-weight: bold; color: #33691e; z-index: 10; }
        
        /* ÊåâÈàïÂü∫Á§éÊ®£Âºè */
        .choice-row { flex: 1.2; display: flex; justify-content: space-around; gap: 8px; }
        .pikmin-btn { 
            background: #fff; 
            border: 3px solid #eee; 
            border-radius: 20px; 
            cursor: pointer; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            outline: none; 
            -webkit-tap-highlight-color: transparent;
            transition: all 0.15s ease-in-out;
        }
        
        /* Áç≤ÂæóÁÑ¶ÈªûÊôÇÈ°ØÁ§∫Á∂†Ëâ≤Ê°ÜÁ∑ö */
        .pikmin-btn:focus-visible, .pikmin-btn:hover { 
            border: 3px solid #8bc34a; 
            background: #f1f8e9; 
        }

        /* ÈªûÊìäÊåâ‰∏ãÁöÑÁû¨ÈñìÂõûÈ•ã */
        .pikmin-btn:active {
            transform: scale(0.92);
            border: 3px solid #4caf50;
            background: #e8f5e9;
        }

        .pikmin-art { width: 35px; height: 50px; position: relative; }
        .p-stem { width: 2px; height: 15px; background: #5d4037; position: absolute; top: 5px; left: 16px; }
        .p-body { width: 22px; height: 28px; border-radius: 45%; border: 1px solid #333; position: absolute; bottom: 0; left: 6px; }
        .p-eye-socket { width: 8px; height: 10px; background: white; border-radius: 50%; border: 1.5px solid #333; position: absolute; top: 5px; }
        .p-pupil { width: 4px; height: 5px; background: black; border-radius: 50%; position: absolute; top: 2.5px; left: 2px; }
        .eye-l { left: -1px; } .eye-r { right: -1px; }
        .ghost-eye-l { border: 1.5px solid #448aff !important; }
        .ghost-eye-l .p-pupil { background: transparent !important; }
        .ghost-eye-r { border: none !important; background: transparent !important; }
        .ghost-eye-r .p-pupil { width: 3px; height: 3px; background: #448aff !important; top: 4px; left: 3px; }
        .p-leaf { width: 15px; height: 10px; background: #4caf50; border-radius: 50% 0; border: 1px solid #2e7d32; position: absolute; top: -3px; left: 16px; transform: rotate(-20deg); }
        .p-bud { width: 10px; height: 12px; background: #fb8c00; border-radius: 50%; border: 1px solid #e65100; position: absolute; top: -5px; left: 12px; }
        .p-flower { position: absolute; top: -12px; left: 8px; font-size: 16px; }
        .num { font-size: 24px; font-weight: bold; color: #444; }
        #msg { height: 25px; font-weight: bold; color: #555; font-size: 14px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); border-radius: 30px; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

<div id="game-box">
    <div class="overlay" id="finish-screen">
        <h1 style="color: #4caf50; margin: 10px;">üåü ÊåëÊà∞ÊàêÂäüÔºÅ</h1>
        <div id="unlock-msg" style="margin-bottom: 15px; font-weight: bold; color: #f57c00; white-space: pre-wrap;"></div>
        <button onclick="restartGame()" style="padding: 12px 30px; font-size: 20px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 15px;">‰∏ã‰∏ÄÂ†¥ÂÜíÈö™ÔºÅ</button>
    </div>
    <div class="header">
        <span style="font-weight:bold;">ÈÄ≤Â∫¶: <span id="q-num">1</span>/10</span>
        <select id="base-num" onchange="restartGame()">
            <option value="2">2 ÁöÑ‰πòÊ≥ïË°®</option><option value="3">3 ÁöÑ‰πòÊ≥ïË°®</option>
            <option value="4">4 ÁöÑ‰πòÊ≥ïË°®</option><option value="5">5 ÁöÑ‰πòÊ≥ïË°®</option>
            <option value="6">6 ÁöÑ‰πòÊ≥ïË°®</option><option value="7">7 ÁöÑ‰πòÊ≥ïË°®</option>
            <option value="8">8 ÁöÑ‰πòÊ≥ïË°®</option><option value="9">9 ÁöÑ‰πòÊ≥ïË°®</option>
            <option value="mixed">Á∂úÂêà 2~9 Á∑¥Áøí</option>
        </select>
    </div>
    <div class="progress-container"><div id="progress-bar"></div></div>
    <div class="stage"><div id="monster-host"></div><div class="math" id="quest">? x ?</div></div>
    <div class="choice-row" id="choices"></div>
    <div id="msg">ÁôºÁèæÁõÆÊ®ôÔºÅÊ¥æÂá∫ÁöÆÂÖãÊïèÔºÅ</div>
    <div id="collection-container">
        <div class="collection-hint">ËëâÂ≠ê(2) ‚Üí Ëä±Ëãû(2) ‚Üí Ëä±Êúµ(1) ÂÆåÊàêÊî∂ÈõÜÔºÅ</div>
        <div class="collection-row" id="row-leaf"></div>
        <div class="collection-row" id="row-bud"></div>
        <div class="collection-row" id="row-flower"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') { osc.frequency.setValueAtTime(523, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); } 
        else { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); }
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }
    const pikminConfig = [
        { id: 0, key: '--red', name: 'Á¥Ö', hex: '#ff5252' }, { id: 1, key: '--yellow', name: 'ÈªÉ', hex: '#ffd740' }, { id: 2, key: '--blue', name: 'Ëóç', hex: '#448aff' },
        { id: 3, key: '--purple', name: 'Á¥´', hex: '#9c27b0' }, { id: 4, key: '--white', name: 'ÁôΩ', hex: '#ffffff', eye: '#ff5252', pupil: 'transparent' },
        { id: 5, key: '--rock', name: 'Â≤©', hex: '#607d8b' }, { id: 6, key: '--wing', name: 'ÁæΩ', hex: '#f48fb1', eye: '#e1f5fe', pupil: 'transparent' },
        { id: 7, key: '--ice', name: 'ÂÜ∞', hex: '#b3e5fc' }, { id: 8, key: '--ghost', name: 'ÂÖâ', hex: '#ccff00', isGhost: true }
    ];
    const monsterTemplates = [
        `<div class="bulborb"><div class="eye left"></div><div class="eye right"></div><div class="spots"></div><div class="leg" style="left: 40px;"></div><div class="leg" style="right: 40px;"></div></div>`,
        `<div class="breadbug"><div class="bread-face"><div style="display:flex; justify-content:center; gap:4px"><div style="width:5px;height:5px;background:#000;border-radius:50%"></div><div style="width:5px;height:5px;background:#000;border-radius:50%"></div></div><div class="bread-snout"></div></div><div class="leg" style="left:40px; width:15px; bottom:-10px"></div><div class="leg" style="left:100px; width:15px; bottom:-10px"></div></div>`,
        `<div class="wollywog"><div class="eye left"></div><div class="eye right"></div><div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); width:10px; height:10px; background:#9e9d24; border-radius:50%; box-shadow: 20px -10px 0 #9e9d24, -20px -10px 0 #9e9d24;"></div><div class="leg" style="left:-10px; width:30px; bottom:0; border-radius:20px"></div><div class="leg" style="right:-10px; width:30px; bottom:0; border-radius:20px"></div></div>`,
        `<div class="snagret-box"><div class="snagret-hole"></div><div class="snagret-neck"><div class="snagret-head"><div style="position:absolute; width:6px; height:6px; background:red; border-radius:50%; top:15px; left:15px"></div><div class="snagret-beak"></div></div></div></div>`,
        `<div class="wraith-body"><div class="wraith-roller"></div></div>`,
        `<div class="blowhog"><div class="blowhog-stripes"></div><div class="blowhog-snout"></div><div style="position:absolute; top:35px; left:45px; width:10px; height:10px; background:#000; border-radius:50%; border:2px solid #fff"></div></div>`
    ];
    function getMushroomHtml(color) {
        const effects = ['effect-growth', 'effect-glow', 'effect-fire'];
        const chosenEffect = effects[Math.floor(Math.random() * effects.length)];
        let html = `<div class="mush-group ${chosenEffect}" style="--m-color: ${color}">`;
        if(chosenEffect === 'effect-fire') { for(let p=0; p<12; p++) html += `<div class="m-fire-flare" style="left:${10 + Math.random()*80}%; animation-delay:${Math.random()}s"></div>`; }
        html += `<div class="mushroom m-giant"><div class="m-cap"><div class="m-spots"></div></div><div class="m-gills"></div><div class="m-stem"></div></div>`;
        for(let i=0; i<4; i++) {
            const x = (Math.random() - 0.5) * 160; const y = (Math.random() - 0.5) * 30;
            const s = 0.5 + Math.random() * 0.4;
            html += `<div class="mushroom m-small" style="bottom:${y}px; left:calc(50% + ${x}px); transform:scale(${s}); z-index:4;"><div class="m-cap"></div><div class="m-gills"></div><div class="m-stem"></div></div>`;
        }
        return html + `</div>`;
    }
    const LEAF_MAX = 2; const BUD_MAX = 2; const FLOWER_MAX = 1;
    let inventory = JSON.parse(localStorage.getItem('pikmin_inventory_final')) || pikminConfig.map(p => ({ leaf: 0, bud: 0, flower: 0 }));
    let questionPool = [], solvedCount = 0, targetVal = 0, mushIndices = [];
    
    function createPikminHtml(config, type) {
        let headHtml = type === 'leaf' ? '<div class="p-leaf"></div>' : type === 'bud' ? '<div class="p-bud"></div>' : '<div class="p-flower">üå∏</div>';
        let lClass = config.isGhost ? "p-eye-socket eye-l ghost-eye-l" : "p-eye-socket eye-l";
        let rClass = config.isGhost ? "p-eye-socket eye-r ghost-eye-r" : "p-eye-socket eye-r";
        return `<div class="pikmin-art"><div class="p-stem"></div>${headHtml}<div class="p-body" style="background:var(${config.key})"><div class="${lClass}" style="background:${config.eye || 'white'}"><div class="p-pupil" style="background:${config.pupil || 'black'}"></div></div><div class="${rClass}" style="background:${config.eye || 'white'}"><div class="p-pupil" style="background:${config.pupil || 'black'}"></div></div></div></div>`;
    }
    
    function updateInventoryDisplay() {
        ['leaf', 'bud', 'flower'].forEach(type => {
            const row = document.getElementById(`row-${type}`); row.innerHTML = '';
            pikminConfig.forEach((p, index) => {
                const count = inventory[index][type];
                const item = document.createElement('div');
                item.className = `book-item ${count > 0 ? 'unlocked' : ''}`;
                item.innerHTML = createPikminHtml(p, type) + (count > 0 ? `<div class="count-badge">${count}</div>` : '');
                row.appendChild(item);
            });
        });
    }

    function handleReward() {
        let availableIndices = []; pikminConfig.forEach((_, i) => { if (inventory[i].flower < FLOWER_MAX) availableIndices.push(i); });
        if (availableIndices.length === 0) return;
        let randIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        let pName = pikminConfig[randIdx].name;
        if (inventory[randIdx].leaf < LEAF_MAX && inventory[randIdx].bud === 0 && inventory[randIdx].flower === 0) inventory[randIdx].leaf += 1;
        else if (inventory[randIdx].bud < BUD_MAX && inventory[randIdx].flower === 0) { inventory[randIdx].leaf = LEAF_MAX; inventory[randIdx].bud += 1; }
        else if (inventory[randIdx].flower < FLOWER_MAX) { inventory[randIdx].leaf = LEAF_MAX; inventory[randIdx].bud = BUD_MAX; inventory[randIdx].flower += 1; }
        document.getElementById('unlock-msg').innerText = `Áç≤Âæó‰∫Ü ${pName}ÁöÆÂÖãÊïèÁöÑËÉΩÈáèÔºÅ`;
        localStorage.setItem('pikmin_inventory_final', JSON.stringify(inventory));
        updateInventoryDisplay();
    }

    function nextQuestion() {
        // --- ‰øÆÊîπÈªû 1: ÂàáÊèõÈ°åÁõÆÊôÇÂÖàÊ∏ÖÈô§Áï´Èù¢‰∏äÁõÆÂâçÁöÑÁÑ¶Èªû ---
        if (document.activeElement) document.activeElement.blur();
        
        if (solvedCount >= 10) { handleReward(); document.getElementById('finish-screen').style.display = 'flex'; return; }
        const q = questionPool[solvedCount]; targetVal = q.b * q.n;
        document.getElementById('quest').innerText = `${q.b} x ${q.n}`;
        const host = document.getElementById('monster-host');
        if (mushIndices.includes(solvedCount)) { host.innerHTML = getMushroomHtml(pikminConfig[Math.floor(Math.random() * 9)].hex); document.getElementById('msg').innerText = "ÁôºÁèæËòëËèáÔºÅÂ§ßÂÆ∂ÈõÜÂêàÔºÅ"; } 
        else { host.innerHTML = monsterTemplates[Math.floor(Math.random() * monsterTemplates.length)]; document.getElementById('msg').innerText = "ÁôºÁèæÁõÆÊ®ôÔºÅÊ¥æÂá∫ÁöÆÂÖãÊïèÔºÅ"; }
        host.style.transform = "scale(0.65)"; host.style.opacity = "1";
        let opts = [targetVal]; while(opts.length < 3) { let f = q.b * (Math.floor(Math.random() * 9) + 1); if(!opts.includes(f)) opts.push(f); }
        opts.sort(() => Math.random() - 0.5);
        const types = ['leaf', 'bud', 'flower'].sort(() => Math.random() - 0.5);
        const choicesDiv = document.getElementById('choices'); choicesDiv.innerHTML = '';
        opts.forEach((v, i) => {
            const btn = document.createElement('button'); btn.className = 'pikmin-btn';
            const randPikmin = pikminConfig[Math.floor(Math.random() * 9)];
            btn.innerHTML = `${createPikminHtml(randPikmin, types[i])}<div class="num">${v}</div>`;
            btn.onclick = () => {
                // --- ‰øÆÊîπÈªû 2: ÈªûÊìäÁû¨Èñì‰∏ªÂãïÂ§±ÂéªÁÑ¶ÈªûÔºåÁ¢∫‰øùÊ®£ÂºèÂõûÊ≠∏ ---
                btn.blur();
                if(v === targetVal) { playSound('correct'); solvedCount++; updateUI(); host.style.transform = "scale(0)"; host.style.opacity = "0"; setTimeout(nextQuestion, 700); } 
                else { playSound('wrong'); document.getElementById('msg').innerText = "‚ùå ÂÜçÁÆó‰∏Ä‰∏ãÔºÅ"; }
            };
            choicesDiv.appendChild(btn);
        });
    }
    function updateUI() { document.getElementById('progress-bar').style.width = (solvedCount * 10) + '%'; document.getElementById('q-num').innerText = Math.min(solvedCount + 1, 10); }
    function restartGame() {
        const mode = document.getElementById('base-num').value; solvedCount = 0;
        mushIndices = [0,1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5).slice(0, 4);
        if (mode === "mixed") {
            let all = []; for (let b = 2; b <= 9; b++) for (let n = 1; n <= 9; n++) all.push({ b, n });
            questionPool = all.sort(() => Math.random() - 0.5).slice(0, 10);
        } else { let b = parseInt(mode); questionPool = [1,2,3,4,5,6,7,8,9,1].sort(() => Math.random() - 0.5).map(n => ({ b, n })); }
        document.getElementById('finish-screen').style.display = 'none'; updateUI(); updateInventoryDisplay(); nextQuestion();
    }
    updateInventoryDisplay(); restartGame();
</script>
</body>
</html>
