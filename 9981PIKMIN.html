<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çš®å…‹æ•ä¹˜æ³•å†’éšª - éšŠä¼åœ–é‘‘ç‰ˆ</title>
    <style>
        :root {
            --red: #ff5252; --yellow: #ffd740; --blue: #448aff;
            --purple: #9c27b0; --white: #ffffff; --rock: #607d8b;
            --wing: #f48fb1; --ice: #b3e5fc; --ghost: #ccff00;
        }
        body { 
            font-family: "Arial", "Microsoft JhengHei", sans-serif; 
            background-color: #f1f8e9; display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden;
        }

        #game-box { 
            background: white; padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 0 #aed581; text-align: center; 
            width: 98vw; height: 85vh; display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
        }

        /* åœ–é‘‘å€èª¿æ•´ï¼šéš¨è¢å¹•å¯¬åº¦ç¸®æ”¾ä¸¦ä¿æŒä¸€åˆ— */
        #collection-book {
            margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 20px;
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            gap: 2px; 
            border: 2px dashed #aed581;
            flex-wrap: nowrap; /* å¼·åˆ¶ä¸æ›è¡Œ */
            overflow: hidden;
        }
        .book-item { 
            flex: 1; 
            max-width: 50px; 
            aspect-ratio: 1/1.2;
            position: relative; 
            opacity: 0.2; 
            filter: grayscale(1); 
            transition: 0.5s; 
            transform: scale(0.8);
        }
        .book-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(0.9) translateY(-5px); }

        .header { display: flex; justify-content: space-between; align-items: center; height: 40px; margin-bottom: 5px;}
        select { padding: 5px; border-radius: 10px; border: 2px solid #8bc34a; font-size: 16px; }
        
        .progress-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-bottom: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }

        .stage { flex: 2; background: #fffde7; border-radius: 20px; border: 4px solid #fff176; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monster { font-size: clamp(40px, 10vh, 80px); transition: 0.4s; }
        .math { font-size: clamp(50px, 12vh, 100px); font-weight: bold; color: #33691e; }

        .choice-row { flex: 1.5; display: flex; justify-content: space-around; gap: 10px; }
        .pikmin-btn { background: #fff; border: 3px solid #eee; border-radius: 20px; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .pikmin-btn:hover { transform: translateY(-5px); border-color: #8bc34a; }

        /* çš®å…‹æ•ç¹ªåœ–æ ¸å¿ƒ */
        .pikmin-art { width: 40px; height: 60px; position: relative; }
        .p-stem { width: 2px; height: 20px; background: #5d4037; position: absolute; top: 5px; left: 19px; }
        .p-body { width: 26px; height: 32px; border-radius: 45%; border: 1.5px solid #333; position: absolute; bottom: 0; left: 7px; }
        .p-eye-socket { width: 10px; height: 12px; background: white; border-radius: 50%; border: 1px solid #333; position: absolute; top: 6px; }
        .p-pupil { width: 5px; height: 6px; background: black; border-radius: 50%; position: absolute; top: 3px; left: 2.5px; }
        .eye-l { left: -1px; } .eye-r { right: -1px; }

        /* å¹½éˆçœ¼èª¿æ•´ï¼šå³çœ¼åªæœ‰å°è—é»çœ¼ç  */
        .ghost-eye-l { border: 1.5px solid #448aff !important; }
        .ghost-eye-l .p-pupil { background: transparent !important; }
        .ghost-eye-r { border: none !important; background: transparent !important; }
        .ghost-eye-r .p-pupil { width: 4px; height: 4px; background: #448aff !important; top: 4px; left: 3px; }

        .p-leaf { width: 18px; height: 12px; background: #4caf50; border-radius: 50% 0; border: 1px solid #2e7d32; position: absolute; top: -5px; left: 19px; transform: rotate(-20deg); }
        .p-bud { width: 10px; height: 14px; background: #fb8c00; border-radius: 50%; border: 1px solid #e65100; position: absolute; top: -8px; left: 15px; }
        .p-flower { position: absolute; top: -15px; left: 11px; font-size: 18px; }

        .num { font-size: 28px; font-weight: bold; color: #444; }
        #msg { height: 30px; margin-top: 5px; font-weight: bold; color: #555; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); border-radius: 30px; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

<div id="game-box">
    <div class="overlay" id="finish-screen">
        <h1 id="win-title" style="color: #4caf50; margin: 10px;">ğŸŒŸ æŒ‘æˆ°æˆåŠŸï¼</h1>
        <div id="unlock-msg" style="margin-bottom: 15px; font-weight: bold; color: #f57c00;"></div>
        <button onclick="restartGame()" style="padding: 12px 30px; font-size: 20px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 15px;">ä¸‹ä¸€å ´å†’éšªï¼</button>
    </div>

    <div class="header">
        <span style="font-weight:bold;">é€²åº¦: <span id="q-num">1</span>/10</span>
        <select id="base-num" onchange="restartGame()">
            <option value="2">2 çš„ä¹˜æ³•è¡¨</option><option value="3">3 çš„ä¹˜æ³•è¡¨</option>
            <option value="4">4 çš„ä¹˜æ³•è¡¨</option><option value="5">5 çš„ä¹˜æ³•è¡¨</option>
            <option value="6">6 çš„ä¹˜æ³•è¡¨</option><option value="7">7 çš„ä¹˜æ³•è¡¨</option>
            <option value="8">8 çš„ä¹˜æ³•è¡¨</option><option value="9">9 çš„ä¹˜æ³•è¡¨</option>
            <option value="mixed">ç¶œåˆ 2~9 ç·´ç¿’</option>
        </select>
    </div>

    <div class="progress-container"><div id="progress-bar"></div></div>
    
    <div class="stage">
        <div id="m-icon" class="monster">ğŸ‘¾</div>
        <div class="math" id="quest">? x ?</div>
    </div>

    <div class="choice-row" id="choices"></div>
    <div id="msg">ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼</div>

    <div id="collection-book"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }
    }

    const pikminConfig = [
        { id: 0, name: 'ç´…çš®å…‹æ•', key: '--red' },
        { id: 1, name: 'é»ƒçš®å…‹æ•', key: '--yellow' },
        { id: 2, name: 'è—çš®å…‹æ•', key: '--blue' },
        { id: 3, name: 'ç´«çš®å…‹æ•', key: '--purple' },
        { id: 4, name: 'ç™½çš®å…‹æ•', key: '--white', eye: '#ff5252', pupil: 'transparent' },
        { id: 5, name: 'å²©çŸ³çš®å…‹æ•', key: '--rock' },
        { id: 6, name: 'ç¾½ç¿…çš®å…‹æ•', key: '--wing', eye: '#e1f5fe', pupil: 'transparent' },
        { id: 7, name: 'å†°å‡çš®å…‹æ•', key: '--ice' },
        { id: 8, name: 'ç™¼å…‰çš®å…‹æ•', key: '--ghost', isGhost: true }
    ];

    let unlocked = JSON.parse(localStorage.getItem('pikmin_collection')) || [];
    let questionPool = [], solvedCount = 0, targetVal = 0;

    function createPikminHtml(config, headHtml = '<div class="p-leaf"></div>') {
        let lClass = config.isGhost ? "p-eye-socket eye-l ghost-eye-l" : "p-eye-socket eye-l";
        let rClass = config.isGhost ? "p-eye-socket eye-r ghost-eye-r" : "p-eye-socket eye-r";
        return `
            <div class="pikmin-art">
                <div class="p-stem"></div>
                ${headHtml}
                <div class="p-body" style="background:var(${config.key})">
                    <div class="${lClass}" style="background:${config.eye || 'white'};">
                        <div class="p-pupil" style="background:${config.pupil || 'black'};"></div>
                    </div>
                    <div class="${rClass}" style="background:${config.eye || 'white'};">
                        <div class="p-pupil" style="background:${config.pupil || 'black'};"></div>
                    </div>
                </div>
            </div>`;
    }

    function initCollection() {
        const book = document.getElementById('collection-book');
        book.innerHTML = '';
        pikminConfig.forEach(p => {
            const wrap = document.createElement('div');
            wrap.className = `book-item ${unlocked.includes(p.id) ? 'unlocked' : ''}`;
            wrap.innerHTML = createPikminHtml(p);
            book.appendChild(wrap);
        });
    }

    function restartGame() {
        const mode = document.getElementById('base-num').value;
        solvedCount = 0;
        document.getElementById('msg').innerText = "ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼";
        if (mode === "mixed") {
            let all = [];
            for (let b = 2; b <= 9; b++) for (let n = 1; n <= 9; n++) all.push({ b, n });
            questionPool = all.sort(() => Math.random() - 0.5).slice(0, 10);
        } else {
            let b = parseInt(mode);
            questionPool = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5).slice(0,10).map(n => ({ b, n }));
        }
        document.getElementById('finish-screen').style.display = 'none';
        initCollection();
        updateUI();
        nextQuestion();
    }

    function updateUI() {
        document.getElementById('progress-bar').style.width = (solvedCount * 10) + '%';
        document.getElementById('q-num').innerText = Math.min(solvedCount + 1, 10);
    }

    function nextQuestion() {
        if (solvedCount >= 10) {
            let locked = pikminConfig.filter(p => !unlocked.includes(p.id));
            if (locked.length > 0) {
                let newP = locked[Math.floor(Math.random() * locked.length)];
                unlocked.push(newP.id);
                localStorage.setItem('pikmin_collection', JSON.stringify(unlocked));
                document.getElementById('unlock-msg').innerText = `ğŸ ç²å¾—äº†æ–°å¤¥ä¼´ï¼`;
            } else {
                document.getElementById('unlock-msg').innerText = `éšŠä¼å·²æ»¿ï¼ä½ æ˜¯å¤§å¸«ï¼`;
            }
            document.getElementById('finish-screen').style.display = 'flex';
            initCollection();
            return;
        }

        const q = questionPool[solvedCount];
        targetVal = q.b * q.n;
        document.getElementById('quest').innerText = `${q.b} x ${q.n}`;
        document.getElementById('m-icon').innerText = ['ğŸ','ğŸ•·ï¸','ğŸ¦€','ğŸŒ','ğŸ','ğŸ¦‹','ğŸ„','ğŸ‘¾','ğŸ¦','ğŸ¸'][Math.floor(Math.random()*10)];
        document.getElementById('m-icon').style.transform = "scale(1)";
        document.getElementById('msg').innerText = "ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼";

        let configs = [...pikminConfig].sort(() => Math.random() - 0.5).slice(0, 3);
        let opts = [targetVal];
        while(opts.length < 3) {
            let f = q.b * (Math.floor(Math.random() * 9) + 1);
            if(!opts.includes(f)) opts.push(f);
        }
        opts.sort(() => Math.random() - 0.5);

        let heads = ['<div class="p-leaf"></div>', '<div class="p-bud"></div>', '<div class="p-flower">ğŸŒ¸</div>'].sort(() => Math.random() - 0.5);

        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';

        opts.forEach((v, i) => {
            const btn = document.createElement('div');
            btn.className = 'pikmin-btn';
            btn.innerHTML = `${createPikminHtml(configs[i], heads[i])}<div class="num">${v}</div>`;
            btn.onclick = () => {
                if(v === targetVal) {
                    playSound('correct'); 
                    solvedCount++; 
                    updateUI();
                    document.getElementById('msg').innerText = "âœ¨ æ“Šå€’æ€ªç‰©äº†ï¼";
                    document.getElementById('m-icon').style.transform = "scale(0)";
                    setTimeout(nextQuestion, 600);
                } else {
                    playSound('wrong');
                    document.getElementById('msg').innerText = "âŒ å†ç®—ä¸€ä¸‹ï¼";
                }
            };
            choicesDiv.appendChild(btn);
        });
    }
    initCollection();
    restartGame();
</script>
</body>
</html>