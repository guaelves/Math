<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çš®å…‹æ•ä¹˜æ³•å†’éšª</title>
    <style>
        :root {
            --red: #ff5252; --yellow: #ffd740; --blue: #448aff;
            --purple: #9c27b0; --white: #ffffff; --rock: #607d8b;
            --wing: #f48fb1; --ice: #b3e5fc; --ghost: #ccff00;
        }
        body { 
            font-family: "Arial", "Microsoft JhengHei", sans-serif; 
            background-color: #f1f8e9; display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden;
        }

        #game-box { 
            background: white; padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 0 #aed581; text-align: center; 
            width: 98vw; height: 95vh; display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
        }

        #collection-container {
            margin-top: 10px; padding: 5px; background: #e8f5e9; border-radius: 20px;
            display: flex; flex-direction: column; border: 2px dashed #aed581;
            overflow-y: auto;
        }

        .collection-hint {
            font-size: 14px; color: #2e7d32; font-weight: bold; padding: 8px 0 4px 0;
        }

        .collection-row {
            display: flex; justify-content: space-around; align-items: center;
            gap: 2px; flex-wrap: nowrap; padding: 5px 0; border-bottom: 1px solid #c8e6c9;
        }
        .collection-row:last-child { border-bottom: none; }

        .book-item { 
            flex: 1; max-width: 45px; aspect-ratio: 1/1.2; position: relative; 
            opacity: 0.15; filter: grayscale(1); transition: 0.5s; transform: scale(0.8);
        }
        .book-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(0.9); }
        
        .count-badge {
            position: absolute; top: -5px; right: -5px; background: #ff5252;
            color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px;
            font-weight: bold; z-index: 10; border: 1px solid white;
        }

        .header { display: flex; justify-content: space-between; align-items: center; height: 35px; margin-bottom: 5px;}
        select { padding: 5px; border-radius: 10px; border: 2px solid #8bc34a; font-size: 14px; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 5px; margin-bottom: 5px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }

        .stage { flex: 1.5; background: #fffde7; border-radius: 20px; border: 4px solid #fff176; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monster { font-size: clamp(30px, 8vh, 60px); }
        .math { font-size: clamp(40px, 10vh, 80px); font-weight: bold; color: #33691e; }

        .choice-row { flex: 1.2; display: flex; justify-content: space-around; gap: 8px; }
        .pikmin-btn { 
            background: #fff; border: 3px solid #eee; border-radius: 20px; 
            cursor: pointer; flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; outline: none; -webkit-tap-highlight-color: transparent;
        }
        .pikmin-btn:focus { border: 5px solid #8bc34a; background: #f1f8e9; }

        .pikmin-art { width: 35px; height: 50px; position: relative; }
        .p-stem { width: 2px; height: 15px; background: #5d4037; position: absolute; top: 5px; left: 16px; }
        .p-body { width: 22px; height: 28px; border-radius: 45%; border: 1px solid #333; position: absolute; bottom: 0; left: 6px; }
        
        .p-eye-socket { width: 8px; height: 10px; background: white; border-radius: 50%; border: 1.5px solid #333; position: absolute; top: 5px; }
        .p-pupil { width: 4px; height: 5px; background: black; border-radius: 50%; position: absolute; top: 2.5px; left: 2px; }
        .eye-l { left: -1px; } .eye-r { right: -1px; }

        .ghost-eye-l { border: 1.5px solid #448aff !important; }
        .ghost-eye-l .p-pupil { background: transparent !important; }
        .ghost-eye-r { border: none !important; background: transparent !important; }
        .ghost-eye-r .p-pupil { width: 3px; height: 3px; background: #448aff !important; top: 4px; left: 3px; }

        .p-leaf { width: 15px; height: 10px; background: #4caf50; border-radius: 50% 0; border: 1px solid #2e7d32; position: absolute; top: -3px; left: 16px; transform: rotate(-20deg); }
        .p-bud { width: 10px; height: 12px; background: #fb8c00; border-radius: 50%; border: 1px solid #e65100; position: absolute; top: -5px; left: 12px; }
        .p-flower { position: absolute; top: -12px; left: 8px; font-size: 16px; }

        .num { font-size: 24px; font-weight: bold; color: #444; }
        #msg { height: 25px; font-weight: bold; color: #555; font-size: 14px; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); border-radius: 30px; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

<div id="game-box">
    <div class="overlay" id="finish-screen">
        <h1 style="color: #4caf50; margin: 10px;">ğŸŒŸ æŒ‘æˆ°æˆåŠŸï¼</h1>
        <div id="unlock-msg" style="margin-bottom: 15px; font-weight: bold; color: #f57c00; white-space: pre-wrap;"></div>
        <button onclick="restartGame()" style="padding: 12px 30px; font-size: 20px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 15px;">ä¸‹ä¸€å ´å†’éšªï¼</button>
    </div>

    <div class="header">
        <span style="font-weight:bold;">é€²åº¦: <span id="q-num">1</span>/10</span>
        <select id="base-num" onchange="restartGame()">
            <option value="2">2 çš„ä¹˜æ³•è¡¨</option><option value="3">3 çš„ä¹˜æ³•è¡¨</option>
            <option value="4">4 çš„ä¹˜æ³•è¡¨</option><option value="5">5 çš„ä¹˜æ³•è¡¨</option>
            <option value="6">6 çš„ä¹˜æ³•è¡¨</option><option value="7">7 çš„ä¹˜æ³•è¡¨</option>
            <option value="8">8 çš„ä¹˜æ³•è¡¨</option><option value="9">9 çš„ä¹˜æ³•è¡¨</option>
            <option value="mixed">ç¶œåˆ 2~9 ç·´ç¿’</option>
        </select>
    </div>

    <div class="progress-container"><div id="progress-bar"></div></div>
    
    <div class="stage">
        <div id="m-icon" class="monster">ğŸ‘¾</div>
        <div class="math" id="quest">? x ?</div>
    </div>

    <div class="choice-row" id="choices"></div>
    <div id="msg">ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼</div>

    <div id="collection-container">
        <div class="collection-hint">æ¯æ”¶é›†3éš»åŒå‹æ…‹å³å¯é€²åŒ–ï¼ŒåŠ æ²¹ï¼</div>
        <div class="collection-row" id="row-leaf"></div>
        <div class="collection-row" id="row-bud"></div>
        <div class="collection-row" id="row-flower"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.frequency.setValueAtTime(523, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        }
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    const pikminConfig = [
        { id: 0, key: '--red' }, { id: 1, key: '--yellow' }, { id: 2, key: '--blue' },
        { id: 3, key: '--purple' }, 
        { id: 4, key: '--white', eye: '#ff5252', pupil: 'transparent' },
        { id: 5, key: '--rock' }, 
        { id: 6, key: '--wing', eye: '#e1f5fe', pupil: 'transparent' },
        { id: 7, key: '--ice' }, 
        { id: 8, key: '--ghost', isGhost: true }
    ];

    let inventory = JSON.parse(localStorage.getItem('pikmin_inventory')) || 
                    pikminConfig.map(p => ({ leaf: 0, bud: 0, flower: 0 }));

    let questionPool = [], solvedCount = 0, targetVal = 0;

    function createPikminHtml(config, type) {
        let headHtml = type === 'leaf' ? '<div class="p-leaf"></div>' : 
                       type === 'bud' ? '<div class="p-bud"></div>' : '<div class="p-flower">ğŸŒ¸</div>';
        let lClass = config.isGhost ? "p-eye-socket eye-l ghost-eye-l" : "p-eye-socket eye-l";
        let rClass = config.isGhost ? "p-eye-socket eye-r ghost-eye-r" : "p-eye-socket eye-r";
        
        return `
            <div class="pikmin-art">
                <div class="p-stem"></div>${headHtml}
                <div class="p-body" style="background:var(${config.key})">
                    <div class="${lClass}" style="background:${config.eye || 'white'}">
                        <div class="p-pupil" style="background:${config.pupil || 'black'}"></div>
                    </div>
                    <div class="${rClass}" style="background:${config.eye || 'white'}">
                        <div class="p-pupil" style="background:${config.pupil || 'black'}"></div>
                    </div>
                </div>
            </div>`;
    }

    function updateInventoryDisplay() {
        ['leaf', 'bud', 'flower'].forEach(type => {
            const row = document.getElementById(`row-${type}`);
            row.innerHTML = '';
            pikminConfig.forEach((p, index) => {
                const count = inventory[index][type];
                const item = document.createElement('div');
                item.className = `book-item ${count > 0 ? 'unlocked' : ''}`;
                item.innerHTML = createPikminHtml(p, type) + (count > 0 ? `<div class="count-badge">${count}</div>` : '');
                row.appendChild(item);
            });
        });
    }

    function handleReward() {
        let randIdx = Math.floor(Math.random() * pikminConfig.length);
        let targetType = "leaf";
        
        // æ ¸å¿ƒé‚è¼¯å¾®èª¿ï¼šå¦‚æœå·²ç¶“æœ‰èŠ±è‹ï¼Œçå‹µæœƒå„ªå…ˆç´¯è¨ˆåˆ°èŠ±è‹ä¸Šï¼Œä¸å†å¡åœ¨è‘‰å­
        if (inventory[randIdx].bud > 0 || inventory[randIdx].leaf >= 2) {
            targetType = "bud";
            if (inventory[randIdx].leaf >= 3) inventory[randIdx].leaf = 0; // æ¸…é™¤æ»¿æ‰çš„è‘‰å­
        }

        inventory[randIdx][targetType] += 1;
        let log = `ç²å¾—äº† 1 éš» ${targetType === 'leaf' ? 'è‘‰å­' : 'èŠ±è‹'}ç‰ˆçš®å…‹æ•ï¼`;

        // é€²åŒ–æª¢æŸ¥
        if (inventory[randIdx].leaf >= 3) {
            inventory[randIdx].leaf = 0;
            inventory[randIdx].bud += 1;
            log += `\nâœ¨ 3éš»è‘‰å­é€²åŒ–æˆäº†ã€èŠ±è‹ç‰ˆã€‘ï¼`;
        }
        if (inventory[randIdx].bud >= 3) {
            inventory[randIdx].bud = 0;
            inventory[randIdx].flower += 1;
            log += `\nğŸŒ¸ 3éš»èŠ±è‹é€²åŒ–æˆäº†ã€èŠ±æœµç‰ˆã€‘ï¼`;
        }

        localStorage.setItem('pikmin_inventory', JSON.stringify(inventory));
        document.getElementById('unlock-msg').innerText = log;
        updateInventoryDisplay();
    }

    function nextQuestion() {
        if (document.activeElement) document.activeElement.blur();
        if (solvedCount >= 10) {
            handleReward();
            document.getElementById('finish-screen').style.display = 'flex';
            return;
        }
        const q = questionPool[solvedCount];
        targetVal = q.b * q.n;
        document.getElementById('quest').innerText = `${q.b} x ${q.n}`;
        document.getElementById('m-icon').innerText = ['ğŸ','ğŸ•·ï¸','ğŸ¦€','ğŸŒ','ğŸ','ğŸ¦‹','ğŸ„','ğŸ‘¾','ğŸ¦','ğŸ¸'][Math.floor(Math.random()*10)];
        document.getElementById('m-icon').style.transform = "scale(1)";
        document.getElementById('msg').innerText = "ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼";

        let opts = [targetVal];
        while(opts.length < 3) {
            let f = q.b * (Math.floor(Math.random() * 9) + 1);
            if(!opts.includes(f)) opts.push(f);
        }
        opts.sort(() => Math.random() - 0.5);

        let types = ['leaf', 'bud', 'flower'].sort(() => Math.random() - 0.5);
        let configs = [...pikminConfig].sort(() => Math.random() - 0.5).slice(0, 3);

        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';
        opts.forEach((v, i) => {
            const btn = document.createElement('button');
            btn.className = 'pikmin-btn';
            btn.innerHTML = `${createPikminHtml(configs[i], types[i])}<div class="num">${v}</div>`;
            btn.onclick = () => {
                if(v === targetVal) {
                    playSound('correct'); solvedCount++; updateUI();
                    document.getElementById('msg').innerText = "âœ¨ æ“Šå€’æ€ªç‰©äº†ï¼";
                    document.getElementById('m-icon').style.transform = "scale(0)";
                    setTimeout(nextQuestion, 600);
                } else {
                    playSound('wrong'); document.getElementById('msg').innerText = "âŒ å†ç®—ä¸€ä¸‹ï¼";
                }
            };
            choicesDiv.appendChild(btn);
        });
    }

    function updateUI() {
        document.getElementById('progress-bar').style.width = (solvedCount * 10) + '%';
        document.getElementById('q-num').innerText = Math.min(solvedCount + 1, 10);
    }

    function restartGame() {
        const mode = document.getElementById('base-num').value;
        solvedCount = 0;
        if (mode === "mixed") {
            let all = []; for (let b = 2; b <= 9; b++) for (let n = 1; n <= 9; n++) all.push({ b, n });
            questionPool = all.sort(() => Math.random() - 0.5).slice(0, 10);
        } else {
            let b = parseInt(mode);
            questionPool = [1,2,3,4,5,6,7,8,9,5].sort(() => Math.random() - 0.5).map(n => ({ b, n }));
        }
        document.getElementById('finish-screen').style.display = 'none';
        updateUI();
        updateInventoryDisplay();
        nextQuestion();
    }

    updateInventoryDisplay();
    restartGame();
</script>
</body>
</html>