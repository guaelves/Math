<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>乘法2泡泡遊戲</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    text-align: center;
    background: #fff;
  }
  h1 {
    font-size: 48px;
    margin-top: 20px;
  }
  #question {
    font-size: 60px;
    margin: 20px 0;
    font-weight: bold;
  }
  #bubbles {
    position: relative;
    width: 100%;
    height: 450px;
    margin: 20px 0;
  }
  .bubble {
    position: absolute;
    border: 2px solid #000;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: bold;
  }
  #message {
    font-size: 36px;
    color: #f44336;
    height: 50px;
    margin: 20px 0;
  }
  button {
    font-size: 28px;
    margin: 10px;
    padding: 10px 20px;
    cursor: pointer;
    border: none;
    color: #000;
    border-radius: 8px;
  }
  #startBtn {
    background-color: #ffeb3b; /* 黃色 */
  }
  #restartBtn {
    background-color: #b2fab4; /* 淡綠色 */
  }
  #tableBtn {
    background-color: #b3e5fc; /* 淡藍色 */
  }
</style>
</head>
<body>

<h1>乘法2泡泡遊戲</h1>

<div id="startContainer">
  <button id="startBtn">開始遊戲</button>
</div>

<div id="gameContainer" style="display:none;">
  <div id="question"></div>
  <div id="bubbles"></div>
  <div id="message"></div>
  <div>
    <button id="restartBtn">重新開始</button>
    <button id="tableBtn" onclick="location.href='https://guaelves.github.io/Math/9981/'">回到九九乘法表練習</button>
  </div>
</div>

<script>
let currentQuestion = 0;
let correctAnswers = 0;
const totalQuestions = 9;

// 產生隨機題目
function getRandomQuestion() {
  const n = Math.floor(Math.random() * 9) + 1;
  return {question: `2 × ${n}`, answer: 2 * n};
}

// 產生泡泡，修正小數字卡住問題
function generateBubbles(correctAnswer) {
  const bubbles = [];
  const count = Math.floor(Math.random() * 2) + 5; // 5~6個泡泡
  const used = new Set();
  used.add(correctAnswer);
  bubbles.push(correctAnswer);

  while (bubbles.length < count) {
    let offset = Math.floor(Math.random() * 3) + 1; // 1~3
    let choice;
    if (correctAnswer <= 3) {
      // 小數字只往上加，避免負數
      choice = correctAnswer + offset;
    } else {
      choice = Math.random() < 0.5 ? correctAnswer + offset : correctAnswer - offset;
      if (choice < 1) choice = correctAnswer + offset;
    }
    if (!used.has(choice)) {
      bubbles.push(choice);
      used.add(choice);
    }
  }

  bubbles.sort(() => Math.random() - 0.5);
  return bubbles;
}

// 檢查是否重疊
function isOverlapping(x, y, size, bubbles) {
  for (let b of bubbles) {
    const dx = x - b.x;
    const dy = y - b.y;
    const distance = Math.sqrt(dx*dx + dy*dy);
    if (distance < (size/2 + b.size/2 + 10)) return true;
  }
  return false;
}

// 顯示題目
function showQuestion() {
  const q = getRandomQuestion();
  window.currentAnswer = q.answer;
  const questionDiv = document.getElementById("question");
  questionDiv.textContent = q.question;

  // 自動語音播放
  if ('speechSynthesis' in window) {
    const msg = new SpeechSynthesisUtterance(q.question);
    msg.lang = "zh-TW";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(msg);
  }

  const bubblesDiv = document.getElementById("bubbles");
  bubblesDiv.innerHTML = "";
  const messageDiv = document.getElementById("message");
  messageDiv.textContent = "";

  const bubblesData = generateBubbles(q.answer);
  const createdBubbles = [];

  bubblesData.forEach(num => {
    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const size = Math.floor(Math.random() * 60) + 80; // 80~140px
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.fontSize = `${Math.floor(size / 2.2)}px`;

    let x, y, tries = 0;
    do {
      x = Math.random() * (bubblesDiv.clientWidth - size);
      y = Math.random() * (bubblesDiv.clientHeight - size);
      tries++;
    } while (isOverlapping(x, y, size, createdBubbles) && tries < 200);

    bubble.style.left = `${x}px`;
    bubble.style.top = `${y}px`;

    createdBubbles.push({x, y, size});
    bubble.textContent = num;
    bubble.onclick = () => checkAnswer(num, bubble);
    bubblesDiv.appendChild(bubble);
  });
}

// 檢查答案
function checkAnswer(selected, bubble) {
  const messageDiv = document.getElementById("message");
  if (selected === window.currentAnswer) {
    messageDiv.style.color = "green";
    messageDiv.textContent = "答對！";
    bubble.style.background = "#90ee90"; // 答對變淡綠色
    correctAnswers++;
    setTimeout(() => {
      currentQuestion++;
      if (currentQuestion < totalQuestions) {
        showQuestion();
      } else {
        document.getElementById("question").textContent = "恭喜🎉全部答對！";
        document.getElementById("bubbles").innerHTML = "";
        messageDiv.textContent = "";
      }
    }, 700);
  } else {
    messageDiv.style.color = "#f44336";
    messageDiv.textContent = "答錯！";
    bubble.style.background = "#f44336"; // 紅色破掉
    bubble.style.transform = "scale(0)";
    bubble.style.opacity = "0";
  }
}

// 開始遊戲按鈕
document.getElementById("startBtn").onclick = () => {
  document.getElementById("startContainer").style.display = "none";
  document.getElementById("gameContainer").style.display = "block";
  currentQuestion = 0;
  correctAnswers = 0;
  showQuestion();
}

// 重新開始
document.getElementById("restartBtn").onclick = () => {
  currentQuestion = 0;
  correctAnswers = 0;
  showQuestion();
}
</script>

</body>
</html>
