<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>乘法2泡泡遊戲</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    text-align: center;
    background: #fff;
  }
  h1 {
    font-size: 48px;
    margin-top: 20px;
  }
  #question {
    font-size: 48px;
    margin: 20px 0;
  }
  #bubbles {
    position: relative;
    width: 100%;
    height: 450px;
    margin: 20px 0;
  }
  .bubble {
    position: absolute;
    border: 2px solid #000;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: bold;
  }
  #message {
    font-size: 36px;
    color: #f44336;
    height: 50px;
    margin: 20px 0;
  }
  button {
    font-size: 28px;
    margin: 10px;
    padding: 10px 20px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>乘法2泡泡遊戲</h1>
<div id="question"></div>
<button onclick="speakQuestion()">🔊 播放題目</button>
<div id="bubbles"></div>
<div id="message"></div>
<button id="restartBtn" style="display:none;">重新開始</button>

<script>
let currentQuestion = 0;
let correctAnswers = 0;
const totalQuestions = 9;

function getRandomQuestion() {
  const n = Math.floor(Math.random() * 9) + 1;
  return {question: `2 × ${n}`, answer: 2 * n};
}

function generateBubbles(correctAnswer) {
  const bubbles = [];
  const count = Math.floor(Math.random() * 2) + 5; // 5~6個泡泡
  const used = new Set();
  used.add(correctAnswer);
  bubbles.push(correctAnswer);

  while (bubbles.length < count) {
    let offset = Math.floor(Math.random() * 3) + 1;
    let choice = Math.random() < 0.5 ? correctAnswer + offset : correctAnswer - offset;
    if (choice > 0 && !used.has(choice)) {
      bubbles.push(choice);
      used.add(choice);
    }
  }

  bubbles.sort(() => Math.random() - 0.5);
  return bubbles;
}

function isOverlapping(x, y, size, bubbles) {
  for (let b of bubbles) {
    const dx = x - b.x;
    const dy = y - b.y;
    const distance = Math.sqrt(dx*dx + dy*dy);
    if (distance < (size/2 + b.size/2 + 10)) return true;
  }
  return false;
}

function showQuestion() {
  const q = getRandomQuestion();
  window.currentAnswer = q.answer;
  const questionDiv = document.getElementById("question");
  questionDiv.textContent = q.question;
  speakQuestion(); // 題目語音自動播放
  const bubblesDiv = document.getElementById("bubbles");
  bubblesDiv.innerHTML = "";
  const messageDiv = document.getElementById("message");
  messageDiv.textContent = "";

  const bubblesData = generateBubbles(q.answer);
  const createdBubbles = [];

  bubblesData.forEach(num => {
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    // 隨機大小 80~140
    const size = Math.floor(Math.random() * 60) + 80;
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.fontSize = `${Math.floor(size / 2.2)}px`;

    // 隨機位置且不重疊
    let x, y, tries = 0;
    do {
      x = Math.random() * (bubblesDiv.clientWidth - size);
      y = Math.random() * (bubblesDiv.clientHeight - size);
      tries++;
    } while (isOverlapping(x, y, size, createdBubbles) && tries < 200);

    bubble.style.left = `${x}px`;
    bubble.style.top = `${y}px`;

    createdBubbles.push({x, y, size});

    bubble.textContent = num;
    bubble.onclick = () => checkAnswer(num, bubble);
    bubblesDiv.appendChild(bubble);
  });
}

function checkAnswer(selected, bubble) {
  const messageDiv = document.getElementById("message");
  if (selected === window.currentAnswer) {
    messageDiv.style.color = "green";
    messageDiv.textContent = "答對！";
    correctAnswers++;
    setTimeout(() => {
      currentQuestion++;
      if (currentQuestion < totalQuestions) {
        showQuestion();
      } else {
        document.getElementById("question").textContent = "恭喜🎉全部答對！";
        document.getElementById("bubbles").innerHTML = "";
        document.getElementById("restartBtn").style.display = "inline-block";
        messageDiv.textContent = "";
      }
    }, 700);
  } else {
    messageDiv.style.color = "#f44336";
    messageDiv.textContent = "答錯！";
    bubble.style.transform = "scale(0.8)";
    bubble.style.background = "#ffcdd2";
  }
}

document.getElementById("restartBtn").onclick = () => {
  currentQuestion = 0;
  correctAnswers = 0;
  document.getElementById("restartBtn").style.display = "none";
  showQuestion();
}

// 語音播放題目
function speakQuestion() {
  const questionText = document.getElementById("question").textContent;
  if ('speechSynthesis' in window) {
    const msg = new SpeechSynthesisUtterance(questionText);
    msg.lang = "zh-TW";
    window.speechSynthesis.cancel(); // 取消前一個語音
    window.speechSynthesis.speak(msg);
  }
}

// 初始化
showQuestion();
</script>

</body>
</html>
