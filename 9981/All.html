<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>九九乘法泡泡遊戲</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    background: white;
    text-align: center;
    margin: 0;
    overflow: hidden;
  }
  h1 {
    font-size: 60px;
    color: #333;
    margin-top: 20px;
  }
  #gameArea {
    position: relative;
    width: 100%;
    height: 70vh;
    overflow: hidden;
  }
  .bubble {
    position: absolute;
    border: 3px solid black;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: all 0.3s;
  }
  .bubble.correct {
    background: radial-gradient(circle, #ffe066, #ff8c00);
    border-color: #ff8c00;
    transform: scale(1.1);
  }
  .bubble.wrong {
    background: red;
    color: white;
    animation: pop 0.3s forwards;
  }
  @keyframes pop {
    to {
      opacity: 0;
      transform: scale(0);
    }
  }
  #controls {
    margin-top: 20px;
  }
  button {
    font-size: 28px;
    margin: 5px;
    padding: 10px 25px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
  }
  #startBtn { background: #FFD93D; }
  #restartBtn { background: #B9FBC0; display:none; }
  #backBtn { background: #A0E9FF; display:none; }
  .levelBtn {
    background: #f5f5f5;
    border: 2px solid #aaa;
  }
  #message {
    font-size: 50px;
    color: #333;
    margin-top: 20px;
    min-height: 70px;
  }
</style>
</head>
<body>
  <h1 id="title">九九乘法泡泡遊戲</h1>
  <div id="controls">
    <button class="levelBtn" onclick="setLevel(2)">2 的乘法</button>
    <button class="levelBtn" onclick="setLevel(3)">3 的乘法</button>
    <button class="levelBtn" onclick="setLevel(4)">4 的乘法</button>
    <button class="levelBtn" onclick="setLevel(5)">5 的乘法</button>
    <button class="levelBtn" onclick="setLevel(6)">6 的乘法</button>
    <button class="levelBtn" onclick="setLevel(7)">7 的乘法</button>
    <button class="levelBtn" onclick="setLevel(8)">8 的乘法</button>
    <button class="levelBtn" onclick="setLevel(9)">9 的乘法</button>
  </div>

  <button id="startBtn" onclick="startGame()">開始遊戲</button>
  <div id="gameArea"></div>
  <div id="message"></div>
  <button id="restartBtn" onclick="startGame()">重新開始</button>
  <button id="backBtn" onclick="goBack()">回到九九乘法表練習</button>

<script>
let currentLevel = 2;
let currentQuestion = 1;
let correctAnswers = 0;
const totalQuestions = 9;

function setLevel(level) {
  currentLevel = level;
  document.getElementById("title").textContent = `乘法 ${level} 泡泡遊戲`;
  document.getElementById("message").textContent = "";
  document.getElementById("gameArea").innerHTML = "";
}

function startGame() {
  correctAnswers = 0;
  currentQuestion = 1;
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("restartBtn").style.display = "inline-block";
  document.getElementById("backBtn").style.display = "inline-block";
  nextQuestion();
}

function nextQuestion() {
  if (currentQuestion > totalQuestions) {
    document.getElementById("message").innerHTML = "🎉恭喜全部答對！🎉";
    document.getElementById("gameArea").innerHTML = "";
    return;
  }

  const questionArea = document.getElementById("gameArea");
  questionArea.innerHTML = "";
  const num2 = currentQuestion;
  const correctAnswer = currentLevel * num2;
  const question = `${currentLevel} × ${num2} = ?`;
  document.getElementById("message").textContent = question;

  speak(question);

  const bubbles = generateBubbles(correctAnswer);
  bubbles.forEach(num => {
    const bubble = document.createElement("div");
    bubble.classList.add("bubble");
    const size = Math.floor(Math.random() * 80) + 100;
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.fontSize = `${size * 0.4}px`;
    bubble.textContent = num;
    let placed = false;
    while (!placed) {
      const x = Math.random() * (window.innerWidth - size);
      const y = Math.random() * (window.innerHeight * 0.6 - size);
      bubble.style.left = `${x}px`;
      bubble.style.top = `${y}px`;
      placed = true;
    }
    bubble.onclick = () => {
      if (num === correctAnswer) {
        bubble.classList.add("correct");
        document.getElementById("message").textContent = "✅ 答對了！";
        correctAnswers++;
        currentQuestion++;
        setTimeout(nextQuestion, 1000);
      } else {
        bubble.classList.add("wrong");
        document.getElementById("message").textContent = "❌ 答錯了！";
        setTimeout(() => {
          bubble.remove();
        }, 300);
      }
    };
    questionArea.appendChild(bubble);
  });
}

function generateBubbles(correctAnswer) {
  const bubbles = [];
  const count = 6;
  const used = new Set();
  used.add(correctAnswer);
  bubbles.push(correctAnswer);

  while (bubbles.length < count) {
    let offset = Math.floor(Math.random() * 3) + 1; // 1~3
    let choice = correctAnswer <= 3 ? correctAnswer + offset : (Math.random() < 0.5 ? correctAnswer + offset : correctAnswer - offset);
    if (choice < 1) choice = correctAnswer + offset;
    if (!used.has(choice)) {
      bubbles.push(choice);
      used.add(choice);
    }
  }

  return bubbles.sort(() => Math.random() - 0.5);
}

function goBack() {
  window.location.href = "https://guaelves.github.io/Math/9981/";
}

function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "zh-TW";
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}
</script>
</body>
</html>
