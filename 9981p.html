<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çš®å…‹æ•ä¹˜æ³•å†’éšªï¼šç²¾ç·»æ€ªç‰©åœ–é‘‘ç‰ˆ</title>
    <style>
        :root {
            --red: #ff5252; --yellow: #ffd740; --blue: #448aff;
            --purple: #9c27b0; --white: #ffffff; --rock: #607d8b;
            --wing: #f48fb1; --ice: #b3e5fc; --ghost: #ccff00;
            /* ç²¾ç·»æ€ªç‰©è‰²å½© */
            --bulborb-red: #d32f2f; --bulborb-skin: #f5deb3;
            --bread-light: #e3c08d; --bread-dark: #8b4513;
            --frog-yellow: #fff176; --frog-spot: #9e9d24;
            --snagret-blue: #4fc3f7; --snagret-beak: #ffd54f;
            --blowhog-white: #eeeeee; --wraith-glow: rgba(200, 255, 255, 0.7);
        }
        body { 
            font-family: "Arial", "Microsoft JhengHei", sans-serif; 
            background-color: #f1f8e9; display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden;
        }

        #game-box { 
            background: white; padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 0 #aed581; text-align: center; 
            width: 98vw; height: 95vh; display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
        }

        /* --- ä¿®æ­£å¾Œçš„èˆå°èˆ‡é¡Œç›®ä½ˆå±€ --- */
        .stage { 
            flex: 2; background: #fffde7; border-radius: 20px; border: 4px solid #fff176; 
            margin-bottom: 10px; display: flex; flex-direction: column; 
            justify-content: space-between; align-items: center; 
            position: relative; overflow: hidden; padding: 15px 0;
        }

        /* é¡Œç›®æ¡†ï¼šå›ºå®šåœ¨ä¸Šæ–¹ï¼Œå±¤ç´šæœ€é«˜ */
        .math { 
            font-size: clamp(40px, 10vh, 70px); font-weight: bold; 
            color: #33691e; z-index: 20; position: relative;
            text-shadow: 2px 2px 0px #fff, -2px -2px 0px #fff, 2px -2px 0px #fff, -2px 2px 0px #fff;
        }

        /* æ€ªç‰©å®¹å™¨ï¼šç½®æ–¼é¡Œç›®ä¸‹æ–¹ */
        #monster-container { 
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            transform: scale(0.7); transition: transform 0.4s; z-index: 5;
        }

        /* --- é«˜ç´°ç¯€ CSS æ€ªç‰©åº« --- */
        .leg { position: absolute; width: 10px; height: 20px; background: rgba(0,0,0,0.1); bottom: -15px; border-radius: 5px; }

        .bulborb { position: relative; width: 180px; height: 120px; background: linear-gradient(to right, var(--bulborb-skin) 40%, var(--bulborb-red) 40%); border-radius: 70px 90px 90px 70px; animation: breathe 2s infinite ease-in-out; }
        .bulborb .eye { position: absolute; width: 35px; height: 45px; background: white; border: 2px solid #333; border-radius: 50%; top: -30px; }
        .bulborb .eye.left { left: 25px; transform: rotate(-10deg); } .bulborb .eye.right { left: 70px; transform: rotate(10deg); }
        .bulborb .eye::after { content: ''; position: absolute; width: 10px; height: 10px; background: black; border-radius: 50%; top: 15px; left: 12px; }
        .bulborb .spots { position: absolute; right: 20px; top: 30px; width: 18px; height: 18px; background: white; border-radius: 50%; box-shadow: 30px 20px 0 -2px white, 10px 45px 0 -4px white; }

        .breadbug { position: relative; width: 160px; height: 95px; background: repeating-linear-gradient(to right, var(--bread-light) 0, var(--bread-light) 25px, #d4a373 25px, #d4a373 30px); border-radius: 30px 40px 40px 30px; border: 3px solid var(--bread-dark); animation: crawl 1.2s infinite ease-in-out; }
        .bread-face { position: absolute; left: 5px; top: 32px; z-index: 5; width: 35px; text-align: center; }
        .bread-snout { width: 14px; height: 8px; background: #ffc0cb; border-radius: 50%; margin: 4px auto; }

        .wollywog { position: relative; width: 140px; height: 110px; background: var(--frog-yellow); border-radius: 50% 50% 40% 40%; animation: hop 1.5s infinite ease-in-out; }
        .wollywog .eye { position: absolute; width: 45px; height: 45px; background: white; border: 3px solid #333; border-radius: 50%; top: -25px; }
        .wollywog .eye.left { left: 10px; } .wollywog .eye.right { right: 10px; }
        .wollywog .eye::after { content: ''; position: absolute; width: 20px; height: 20px; background: black; border-radius: 50%; top: 12px; left: 12px; }

        .snagret-box { position: relative; width: 120px; height: 180px; }
        .snagret-hole { width: 120px; height: 30px; background: #3e2723; border-radius: 50%; position: absolute; bottom: 0; }
        .snagret-neck { position: absolute; width: 40px; height: 160px; background: repeating-linear-gradient(45deg, var(--snagret-blue) 0, var(--snagret-blue) 10px, #29b6f6 10px, #29b6f6 20px); bottom: 15px; left: 40px; border-radius: 20px 20px 0 0; animation: emerge 4s infinite ease-in-out; }
        .snagret-head { position: absolute; top: -20px; left: -10px; width: 60px; height: 50px; background: var(--snagret-blue); border-radius: 30px 30px 0 0; }
        .snagret-beak { position: absolute; right: -30px; top: 15px; width: 0; height: 0; border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 40px solid var(--snagret-beak); }

        .wraith-body { position: relative; width: 140px; height: 90px; background: var(--wraith-glow); border-radius: 50% 50% 40% 40%; box-shadow: 0 0 30px #fff; animation: move-wraith 3s infinite linear; }
        .wraith-roller { position: absolute; width: 180px; height: 50px; background: linear-gradient(#757575, #bdbdbd, #757575); border-radius: 10px; bottom: -30px; left: -20px; }

        .blowhog { position: relative; width: 160px; height: 120px; background: var(--blowhog-white); border-radius: 50% 60% 60% 50%; border: 1px solid #ddd; animation: float 3s infinite ease-in-out; }
        .blowhog-stripes { position: absolute; width: 100%; height: 100%; border-radius: inherit; background: repeating-linear-gradient(to right, transparent 0, transparent 30px, #ff8a80 30px, #ff8a80 35px); opacity: 0.4; }
        .blowhog-snout { position: absolute; left: -20px; top: 40px; width: 40px; height: 30px; background: #ff8a80; border-radius: 20px 0 0 20px; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes crawl { 0%, 100% { transform: translateX(-5px); } 50% { transform: translateX(5px); } }
        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-40px); } }
        @keyframes emerge { 0%, 100% { transform: translateY(140px); } 50% { transform: translateY(0); } }
        @keyframes move-wraith { 0%, 100% { transform: translateX(-30px); } 50% { transform: translateX(30px); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }

        /* --- åŸæœ‰ UI æ¨£å¼ --- */
        #collection-container { margin-top: 10px; padding: 5px; background: #e8f5e9; border-radius: 20px; display: flex; flex-direction: column; border: 2px dashed #aed581; overflow-y: auto; }
        .collection-hint { font-size: 14px; color: #2e7d32; font-weight: bold; padding: 8px 0 4px 0; }
        .collection-row { display: flex; justify-content: space-around; align-items: center; gap: 2px; flex-wrap: nowrap; padding: 5px 0; border-bottom: 1px solid #c8e6c9; }
        .book-item { flex: 1; max-width: 45px; aspect-ratio: 1/1.2; position: relative; opacity: 0.15; filter: grayscale(1); transition: 0.5s; transform: scale(0.8); }
        .book-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(0.9); }
        .count-badge { position: absolute; top: -5px; right: -5px; background: #ff5252; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: bold; z-index: 10; border: 1.5px solid white; }
        .header { display: flex; justify-content: space-between; align-items: center; height: 35px; margin-bottom: 5px;}
        select { padding: 5px; border-radius: 10px; border: 2px solid #8bc34a; font-size: 14px; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 5px; margin-bottom: 5px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #4caf50; transition: 0.4s; }
        .choice-row { flex: 1.2; display: flex; justify-content: space-around; gap: 8px; }
        .pikmin-btn { background: #fff; border: 3px solid #eee; border-radius: 20px; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; outline: none; -webkit-tap-highlight-color: transparent; }
        .pikmin-btn:focus { border: 5px solid #8bc34a; background: #f1f8e9; }
        .pikmin-art { width: 35px; height: 50px; position: relative; }
        .p-stem { width: 2px; height: 15px; background: #5d4037; position: absolute; top: 5px; left: 16px; }
        .p-body { width: 22px; height: 28px; border-radius: 45%; border: 1px solid #333; position: absolute; bottom: 0; left: 6px; }
        .p-eye-socket { width: 8px; height: 10px; background: white; border-radius: 50%; border: 1.5px solid #333; position: absolute; top: 5px; }
        .p-pupil { width: 4px; height: 5px; background: black; border-radius: 50%; position: absolute; top: 2.5px; left: 2px; }
        .eye-l { left: -1px; } .eye-r { right: -1px; }
        .p-leaf { width: 15px; height: 10px; background: #4caf50; border-radius: 50% 0; border: 1px solid #2e7d32; position: absolute; top: -3px; left: 16px; transform: rotate(-20deg); }
        .p-bud { width: 10px; height: 12px; background: #fb8c00; border-radius: 50%; border: 1px solid #e65100; position: absolute; top: -5px; left: 12px; }
        .p-flower { position: absolute; top: -12px; left: 8px; font-size: 16px; }
        .num { font-size: 24px; font-weight: bold; color: #444; }
        #msg { height: 25px; font-weight: bold; color: #555; font-size: 14px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); border-radius: 30px; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

<div id="game-box">
    <div class="overlay" id="finish-screen">
        <h1 id="win-title" style="color: #4caf50; margin: 10px;">ğŸŒŸ æŒ‘æˆ°æˆåŠŸï¼</h1>
        <div id="unlock-msg" style="margin-bottom: 15px; font-weight: bold; color: #f57c00; white-space: pre-wrap;"></div>
        <button id="next-btn" onclick="restartGame()" style="padding: 12px 30px; font-size: 20px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 15px;">ä¸‹ä¸€å ´å†’éšªï¼</button>
    </div>

    <div class="header">
        <span style="font-weight:bold;">é€²åº¦: <span id="q-num">1</span>/10</span>
        <select id="base-num" onchange="restartGame()">
            <option value="2">2 çš„ä¹˜æ³•è¡¨</option><option value="3">3 çš„ä¹˜æ³•è¡¨</option>
            <option value="4">4 çš„ä¹˜æ³•è¡¨</option><option value="5">5 çš„ä¹˜æ³•è¡¨</option>
            <option value="6">6 çš„ä¹˜æ³•è¡¨</option><option value="7">7 çš„ä¹˜æ³•è¡¨</option>
            <option value="8">8 çš„ä¹˜æ³•è¡¨</option><option value="9">9 çš„ä¹˜æ³•è¡¨</option>
            <option value="mixed">ç¶œåˆ 2~9 ç·´ç¿’</option>
        </select>
    </div>

    <div class="progress-container"><div id="progress-bar"></div></div>
    
    <div class="stage">
        <div class="math" id="quest">? x ?</div>
        <div id="monster-container"></div>
    </div>

    <div class="choice-row" id="choices"></div>
    <div id="msg">ç™¼ç¾ç›®æ¨™ï¼æ´¾å‡ºçš®å…‹æ•ï¼</div>

    <div id="collection-container">
        <div class="collection-hint">è‘‰å­(2) â†’ èŠ±è‹(2) â†’ èŠ±æœµ(1) å®Œæˆæ”¶é›†ï¼</div>
        <div class="collection-row" id="row-leaf"></div>
        <div class="collection-row" id="row-bud"></div>
        <div class="collection-row" id="row-flower"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.frequency.setValueAtTime(523, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        }
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    // ç²¾ç·»æ€ªç‰© HTML æ¨¡æ¿
    const monsterTemplates = [
        `<div class="bulborb"><div class="eye left"></div><div class="eye right"></div><div class="spots"></div><div class="leg" style="left: 40px;"></div><div class="leg" style="right: 40px;"></div></div>`,
        `<div class="breadbug"><div class="bread-face"><div style="display:flex; justify-content:center; gap:4px"><div style="width:5px;height:5px;background:#000;border-radius:50%"></div><div style="width:5px;height:5px;background:#000;border-radius:50%"></div></div><div class="bread-snout"></div></div><div class="leg" style="left:40px; width:15px; bottom:-10px"></div><div class="leg" style="left:100px; width:15px; bottom:-10px"></div></div>`,
        `<div class="wollywog"><div class="eye left"></div><div class="eye right"></div><div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); width:10px; height:10px; background:#9e9d24; border-radius:50%; box-shadow: 20px -10px 0 #9e9d24, -20px -10px 0 #9e9d24;"></div><div class="leg" style="left:-10px; width:30px; bottom:0; border-radius:20px"></div><div class="leg" style="right:-10px; width:30px; bottom:0; border-radius:20px"></div></div>`,
        `<div class="snagret-box"><div class="snagret-hole"></div><div class="snagret-neck"><div class="snagret-head"><div style="position:absolute; width:6px; height:6px; background:red; border-radius:50%; top:15px; left:15px"></div><div class="snagret-beak"></div></div></div></div>`,
        `<div class="wraith-body"><div class="wraith-roller"></div></div>`,
        `<div class="blowhog"><div class="blowhog-stripes"></div><div class="blowhog-snout"></div><div style="position:absolute; top:35px; left:45px; width:10px; height:10px; background:#000; border-radius:50%; border:2px solid #fff"></div></div>`
    ];

    const pikminConfig = [
        { id: 0, key: '--red', name: 'ç´…' }, { id: 1, key: '--yellow', name: 'é»ƒ' }, { id: 2, key: '--blue', name: 'è—' },
        { id: 3, key: '--purple', name: 'ç´«' }, { id: 4, key: '--white', name: 'ç™½', eye: '#ff5252' },
        { id: 5, key: '--rock', name: 'å²©' }, { id: 6, key: '--wing', name: 'ç¾½', eye: '#e1f5fe' },
        { id: 7, key: '--ice', name: 'å†°' }, { id: 8, key: '--ghost', name: 'å…‰' }
    ];

    const LEAF_MAX = 2; const BUD_MAX = 2; const FLOWER_MAX = 1;
    let inventory = JSON.parse(localStorage.getItem('pikmin_inventory_final')) || pikminConfig.map(p => ({ leaf: 0, bud: 0, flower: 0 }));
    let questionPool = [], solvedCount = 0, targetVal = 0;

    function createPikminHtml(config, type) {
        let headHtml = type === 'leaf' ? '<div class="p-leaf"></div>' : type === 'bud' ? '<div class="p-bud"></div>' : '<div class="p-flower">ğŸŒ¸</div>';
        return `
            <div class="pikmin-art">
                <div class="p-stem"></div>${headHtml}
                <div class="p-body" style="background:var(${config.key})">
                    <div class="p-eye-socket eye-l" style="background:${config.eye || 'white'}"><div class="p-pupil"></div></div>
                    <div class="p-eye-socket eye-r" style="background:${config.eye || 'white'}"><div class="p-pupil"></div></div>
                </div>
            </div>`;
    }

    function updateInventoryDisplay() {
        ['leaf', 'bud', 'flower'].forEach(type => {
            const row = document.getElementById(`row-${type}`); row.innerHTML = '';
            pikminConfig.forEach((p, index) => {
                const count = inventory[index][type];
                const item = document.createElement('div');
                item.className = `book-item ${count > 0 ? 'unlocked' : ''}`;
                item.innerHTML = createPikminHtml(p, type) + (count > 0 ? `<div class="count-badge">${count}</div>` : '');
                row.appendChild(item);
            });
        });
    }

    function handleReward() {
        let availableIndices = [];
        pikminConfig.forEach((_, i) => { if (inventory[i].flower < FLOWER_MAX) availableIndices.push(i); });
        if (availableIndices.length === 0) return;
        let randIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        let pName = pikminConfig[randIdx].name;
        let log = "";
        if (inventory[randIdx].leaf < LEAF_MAX) { inventory[randIdx].leaf++; log = `ç²å¾—äº† ${pName}çš®å…‹æ•(è‘‰å­)ï¼`; }
        else if (inventory[randIdx].bud < BUD_MAX) { inventory[randIdx].bud++; log = `é€²åŒ–ï¼${pName}çš®å…‹æ•é•·å‡ºèŠ±è‹ï¼`; }
        else { inventory[randIdx].flower++; log = `ç¥ä¹å…¶æŠ€ï¼${pName}çš®å…‹æ•é–‹èŠ±äº†ï¼ğŸŒ¸`; }
        document.getElementById('unlock-msg').innerText = log;
        localStorage.setItem('pikmin_inventory_final', JSON.stringify(inventory));
        updateInventoryDisplay();
    }

    function nextQuestion() {
        if (solvedCount >= 10) { handleReward(); document.getElementById('finish-screen').style.display = 'flex'; return; }
        const q = questionPool[solvedCount];
        targetVal = q.b * q.n;
        document.getElementById('quest').innerText = `${q.b} x ${q.n}`;
        const container = document.getElementById('monster-container');
        container.style.transform = "scale(0.7)";
        container.innerHTML = monsterTemplates[Math.floor(Math.random() * monsterTemplates.length)];
        
        let opts = [targetVal];
        while(opts.length < 3) {
            let f = q.b * (Math.floor(Math.random() * 9) + 1);
            if(!opts.includes(f)) opts.push(f);
        }
        opts.sort(() => Math.random() - 0.5);
        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';
        opts.forEach((v, i) => {
            const btn = document.createElement('button');
            btn.className = 'pikmin-btn';
            btn.innerHTML = `${createPikminHtml(pikminConfig[Math.floor(Math.random()*9)], 'leaf')}<div class="num">${v}</div>`;
            btn.onclick = () => {
                if(v === targetVal) {
                    playSound('correct'); solvedCount++; updateUI();
                    container.style.transform = "scale(0)";
                    setTimeout(nextQuestion, 800);
                } else { playSound('wrong'); }
            };
            choicesDiv.appendChild(btn);
        });
    }

    function updateUI() {
        document.getElementById('progress-bar').style.width = (solvedCount * 10) + '%';
        document.getElementById('q-num').innerText = Math.min(solvedCount + 1, 10);
    }

    function restartGame() {
        const mode = document.getElementById('base-num').value;
        solvedCount = 0;
        if (mode === "mixed") {
            let all = []; for (let b = 2; b <= 9; b++) for (let n = 1; n <= 9; n++) all.push({ b, n });
            questionPool = all.sort(() => Math.random() - 0.5).slice(0, 10);
        } else {
            let b = parseInt(mode);
            questionPool = [1,2,3,4,5,6,7,8,9,5].sort(() => Math.random() - 0.5).map(n => ({ b, n }));
        }
        document.getElementById('finish-screen').style.display = 'none';
        updateUI(); updateInventoryDisplay(); nextQuestion();
    }

    updateInventoryDisplay();
    restartGame();
</script>
</body>
</html>